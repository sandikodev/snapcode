<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SnapCode - ngode-ngide kode ngadi-ngadi</title>
  
  <!-- SEO Meta Tags -->
  <meta name="description" content="Capture Markdown & Code Beautifier - Create beautiful images of your markdown with Fira Code ligatures, Mermaid diagrams, and KaTeX math formulas">
  <meta name="keywords" content="markdown, code beautifier, screenshot, carbon, fira code, mermaid, katex, code to image">
  <meta name="author" content="@sandikodev">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://sandikodev.github.io/snapcode/">
  <meta property="og:title" content="SnapCode - Capture Markdown & Code Beautifier">
  <meta property="og:description" content="Create beautiful images of your markdown with Fira Code ligatures, Mermaid diagrams, and KaTeX math formulas">
  <meta property="og:site_name" content="SnapCode.me">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://sandikodev.github.io/snapcode/">
  <meta property="twitter:title" content="SnapCode - Capture Markdown & Code Beautifier">
  <meta property="twitter:description" content="Create beautiful images of your markdown with Fira Code ligatures, Mermaid diagrams, and KaTeX math formulas">
  <meta property="twitter:creator" content="@sandikodev">
  
  <!-- Canonical URL -->
  <link rel="canonical" href="https://sandikodev.github.io/snapcode/">
  
  <!-- Structured Data (JSON-LD) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "SnapCode",
    "description": "Create beautiful images of your markdown with OS window simulations, Fira Code ligatures, Mermaid diagrams, and KaTeX math formulas",
    "url": "https://sandikodev.github.io/snapcode",
    "applicationCategory": "DeveloperApplication",
    "operatingSystem": "Any",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "author": {
      "@type": "Person",
      "name": "sandikodev",
      "url": "https://github.com/sandikodev"
    },
    "datePublished": "2025-12-10",
    "softwareVersion": "1.0.0"
  }
  </script>
  
  <!-- Favicon & Icons -->
  <link rel="icon" type="image/x-icon" href="static/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="static/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="static/favicon-32x32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="static/apple-touch-icon.png">
  <link rel="manifest" href="static/site.webmanifest">
  <meta name="theme-color" content="#8b5cf6">
  
  <!-- Open Graph Image -->
  <meta property="og:image" content="https://sandikodev.github.io/snapcode/static/brand.png">
  
  <!-- DNS Prefetch & Preconnect for CDN -->
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
  
  <!-- Fira Code Font with font-display swap -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- KaTeX - Lazy loaded when enabled -->
  <!-- Moved to dynamic loading in script -->
  
  <!-- Inline Prism CSS to avoid CORS -->
  <style>
    code[class*="language-"],
    pre[class*="language-"] {
      color: #ccc;
      background: none;
      font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
      font-size: 1em;
      text-align: left;
      white-space: pre;
      word-spacing: normal;
      word-break: normal;
      word-wrap: normal;
      line-height: 1.5;
      tab-size: 4;
      hyphens: none;
    }
    pre[class*="language-"] {
      padding: 1em;
      margin: .5em 0;
      overflow: auto;
    }
    :not(pre) > code[class*="language-"],
    pre[class*="language-"] {
      background: #2d2d2d;
    }
    :not(pre) > code[class*="language-"] {
      padding: .1em;
      border-radius: .3em;
      white-space: normal;
    }
    .token.comment,
    .token.block-comment,
    .token.prolog,
    .token.doctype,
    .token.cdata {
      color: #999;
    }
    .token.punctuation {
      color: #ccc;
    }
    .token.tag,
    .token.attr-name,
    .token.namespace,
    .token.deleted {
      color: #e2777a;
    }
    .token.function-name {
      color: #6196cc;
    }
    .token.boolean,
    .token.number,
    .token.function {
      color: #f08d49;
    }
    .token.property,
    .token.class-name,
    .token.constant,
    .token.symbol {
      color: #f8c555;
    }
    .token.selector,
    .token.important,
    .token.atrule,
    .token.keyword,
    .token.builtin {
      color: #cc99cd;
    }
    .token.string,
    .token.char,
    .token.attr-value,
    .token.regex,
    .token.variable {
      color: #7ec699;
    }
    .token.operator,
    .token.entity,
    .token.url {
      color: #67cdcc;
    }
    .token.important,
    .token.bold {
      font-weight: bold;
    }
    .token.italic {
      font-style: italic;
    }
    .token.entity {
      cursor: help;
    }
    .token.inserted {
      color: green;
    }
    
    /* GitHub Light Theme Override */
    .theme-github code[class*="language-"],
    .theme-github pre[class*="language-"] {
      color: #24292e;
    }
    .theme-github :not(pre) > code[class*="language-"],
    .theme-github pre[class*="language-"] {
      background: #f6f8fa;
    }
    .theme-github .token.comment,
    .theme-github .token.prolog,
    .theme-github .token.doctype,
    .theme-github .token.cdata {
      color: #6a737d;
    }
    .theme-github .token.punctuation {
      color: #24292e;
    }
    .theme-github .token.property,
    .theme-github .token.tag,
    .theme-github .token.boolean,
    .theme-github .token.number,
    .theme-github .token.constant,
    .theme-github .token.symbol,
    .theme-github .token.deleted {
      color: #005cc5;
    }
    .theme-github .token.selector,
    .theme-github .token.attr-name,
    .theme-github .token.string,
    .theme-github .token.char,
    .theme-github .token.builtin,
    .theme-github .token.inserted {
      color: #032f62;
    }
    .theme-github .token.operator,
    .theme-github .token.entity,
    .theme-github .token.url,
    .theme-github .language-css .token.string,
    .theme-github .style .token.string {
      color: #d73a49;
    }
    .theme-github .token.atrule,
    .theme-github .token.attr-value,
    .theme-github .token.keyword {
      color: #d73a49;
    }
    .theme-github .token.function,
    .theme-github .token.class-name {
      color: #6f42c1;
    }
    .theme-github .token.regex,
    .theme-github .token.important,
    .theme-github .token.variable {
      color: #e36209;
    }
  </style>
  
  <!-- Tailwind CSS - MUST load first (blocking) -->
  <script>window.tailwind = { config: {} }</script>
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  
  <!-- Preload critical scripts -->
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" as="script">
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js" as="script">
  
  <!-- Non-critical scripts (defer for non-blocking) -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  
  <!-- Heavy dependencies - Lazy loaded when needed -->
  <!-- Mermaid & KaTeX loaded dynamically -->
  
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
  
  <style>
    /* Critical CSS - prevent FOUC */
    body { 
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    body.loaded { 
      opacity: 1; 
    }
    
    @keyframes gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .animated-bg {
      background: linear-gradient(-45deg, #1a1a2e, #16213e, #0f3460, #533483);
      background-size: 400% 400%;
      animation: gradient 15s ease infinite;
    }
    
    /* Markdown bullet points fix - override Tailwind reset */
    .preview-content ul,
    .preview-content ol {
      margin: 0.5em 0 !important;
      padding-left: 2em !important;
    }
    .preview-content ul {
      list-style: disc outside !important;
    }
    .preview-content ol {
      list-style: decimal outside !important;
    }
    .preview-content li {
      display: list-item !important;
      margin: 0.25em 0 !important;
    }
    .preview-content ul ul { list-style-type: circle !important; }
    .preview-content ol ol { list-style-type: lower-alpha !important; }
    
    /* Focus indicators for accessibility */
    button:focus-visible,
    select:focus-visible,
    input:focus-visible,
    textarea:focus-visible {
      outline: 2px solid #8b5cf6 !important;
      outline-offset: 2px !important;
    }
    
    /* Skip to content link */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: #8b5cf6;
      color: white;
      padding: 8px 16px;
      z-index: 100;
      transition: top 0.3s;
    }
    .skip-link:focus {
      top: 0;
    }
    
    /* Fullscreen mode */
    .fullscreen-mode {
      position: fixed !important;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 9999;
      background: #1a1a2e;
      padding: 1rem;
      overflow: auto;
    }
    .fullscreen-mode .preview-wrapper {
      max-width: 100% !important;
      height: calc(100vh - 2rem);
    }
    
    /* Print styles */
    @media print {
      body { background: white !important; }
      .no-print { display: none !important; }
      .preview-content { max-height: none !important; overflow: visible !important; }
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
      .toolbar-buttons { flex-wrap: wrap; gap: 0.25rem; }
      .toolbar-buttons button { padding: 0.375rem 0.5rem; font-size: 0.75rem; }
      .toolbar-buttons button span { display: none; }
      main { padding: 1rem !important; }
      textarea { height: 200px !important; }
    }
  </style>
</head>
<body>
  <!-- Skip to main content for accessibility -->
  <a href="#main-content" class="skip-link">Skip to main content</a>
  
  <div x-data="app()" x-init="init(); $nextTick(() => document.body.classList.add('loaded'))">
    <style x-html="styles"></style>
    
    <!-- Toast Notification -->
    <div 
      x-show="toast.show" 
      x-transition
      class="fixed top-4 right-4 z-50 px-4 py-2 rounded-lg shadow-lg text-white text-sm"
      :class="toast.type === 'error' ? 'bg-red-600' : 'bg-green-600'"
      x-text="toast.message"
    ></div>
    
    <!-- Loading Overlay -->
    <div x-show="isExporting" class="fixed inset-0 bg-black/50 z-40 flex items-center justify-center">
      <div class="bg-gray-800 px-6 py-4 rounded-lg text-white flex items-center gap-3">
        <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
        </svg>
        Exporting...
      </div>
    </div>
    
    <main id="main-content" class="min-h-screen animated-bg p-8" role="main">
      <div class="max-w-7xl mx-auto">
        <div class="text-center mb-8">
          <h1 class="text-4xl font-bold text-white mb-2">SnapCode</h1>
          <p class="text-gray-300 text-lg italic">ngode-ngide kode ngadi-ngadi</p>
          <p class="text-gray-400 text-sm mt-2">Create beautiful images of your markdown</p>
          <p class="text-green-400/60 text-xs mt-1" x-show="history.length > 0">âœ“ Auto-saved locally</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Editor -->
          <div class="bg-gray-800 rounded-lg shadow-2xl p-6">
            <!-- Tab Switcher -->
            <div class="flex items-center gap-2 mb-4 border-b border-gray-700 pb-2">
              <button
                @click="editorMode = 'markdown'"
                :class="editorMode === 'markdown' ? 'bg-gray-700 text-white' : 'text-gray-400 hover:text-white'"
                class="px-4 py-2 rounded-t-lg transition text-sm font-medium"
              >
                Markdown
              </button>
              <button
                @click="editorMode = 'explorer'"
                :class="editorMode === 'explorer' ? 'bg-gray-700 text-white' : 'text-gray-400 hover:text-white'"
                class="px-4 py-2 rounded-t-lg transition text-sm font-medium"
              >
                File Explorer
              </button>
            </div>

            <!-- Markdown Editor -->
            <div x-show="editorMode === 'markdown'">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-semibold text-white">Markdown Editor</h2>
              <div class="flex gap-2">
                <button
                  @click="loadSample"
                  class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition flex items-center gap-2 text-sm"
                  title="Load sample content"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                  Sample
                </button>
                <button
                  @click="copyText"
                  class="px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition flex items-center gap-2 text-sm"
                  title="Copy markdown text"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                  </svg>
                  Copy
                </button>
              </div>
            </div>
            
            <textarea
              x-model="content"
              @drop.prevent="handleDrop"
              @dragover.prevent="$el.classList.add('ring-2', 'ring-purple-400')"
              @dragleave="$el.classList.remove('ring-2', 'ring-purple-400')"
              class="w-full h-96 bg-gray-900 text-gray-100 p-4 rounded-lg font-mono text-sm resize-none focus:outline-none focus:ring-2 focus:ring-purple-500"
              placeholder="Start typing, paste content, or drop a file..."
              aria-label="Markdown content editor"
              role="textbox"
              aria-multiline="true"
            ></textarea>

            </div>

            <!-- File Explorer -->
            <div x-show="editorMode === 'explorer'">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-white">File Explorer</h2>
                <div class="flex gap-2">
                  <button
                    @click="loadFolder('content')"
                    :disabled="loadingFolder"
                    :class="loadingFolder ? 'opacity-50 cursor-not-allowed' : ''"
                    class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition flex items-center gap-2 text-sm"
                    title="Load content folder"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                      <path d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-6l-2-2H5a2 2 0 0 0-2 2z"></path>
                    </svg>
                    Content
                  </button>
                  <button
                    @click="loadFolder('docs')"
                    :disabled="loadingFolder"
                    :class="loadingFolder ? 'opacity-50 cursor-not-allowed' : ''"
                    class="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition flex items-center gap-2 text-sm"
                    title="Load docs folder"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                      <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1.707.293l5.414 5.414a1 1 0 0 1.293.707V19a2 2 0 0 1-2 2z"></path>
                    </svg>
                    Docs
                  </button>
                  <button
                    @click="$refs.fileInput.click()"
                    :disabled="loadingFolder"
                    :class="loadingFolder ? 'opacity-50 cursor-not-allowed' : ''"
                    class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition flex items-center gap-2 text-sm"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                      <path d="M12 4v16m8-8H4"></path>
                    </svg>
                    Add File
                  </button>
                </div>
                <input type="file" x-ref="fileInput" @change="addFile" class="hidden" accept=".md,.txt,.js,.html,.css,.json">
              </div>
              
              <div class="bg-gray-900 rounded-lg h-96 overflow-y-auto">
                <!-- Loading State -->
                <template x-if="loadingFolder">
                  <div class="flex flex-col items-center justify-center h-full text-gray-400">
                    <svg class="w-12 h-12 animate-spin mb-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                      <circle cx="12" cy="12" r="10" stroke-opacity="0.25"></circle>
                      <path d="M12 2a10 10 0 0 1 10 10" stroke-opacity="0.75"></path>
                    </svg>
                    <p class="text-sm">Loading files...</p>
                  </div>
                </template>
                
                <!-- Empty State -->
                <template x-if="!loadingFolder && files.length === 0">
                  <div class="flex flex-col items-center justify-center h-full text-gray-500">
                    <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" stroke-width="1" viewBox="0 0 24 24">
                      <path d="M3 7v10a2 2 0 0 02 2h14a2 2 0 0 02-2V9a2 2 0 0 0-2-2h-6l-2-2H5a2 2 0 0 0-2 2z"></path>
                    </svg>
                    <p>No files yet</p>
                    <p class="text-sm mt-2">Click "Content" or "Docs" to load files</p>
                  </div>
                </template>
                
                <!-- File List -->
                <template x-if="!loadingFolder && files.length > 0">
                  <div class="divide-y divide-gray-800">
                    <template x-for="(file, index) in files" :key="index">
                      <div 
                        @click="selectFile(index)"
                        :class="selectedFileIndex === index ? 'bg-purple-600/20 border-l-4 border-purple-500' : 'hover:bg-gray-800'"
                        class="p-3 cursor-pointer transition flex items-center justify-between group"
                      >
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                          <svg class="w-5 h-5 text-blue-400 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                          </svg>
                          <div class="flex-1 min-w-0">
                            <p class="text-white text-sm font-medium truncate" x-text="file.name"></p>
                            <p class="text-gray-500 text-xs" x-text="formatFileSize(file.size)"></p>
                          </div>
                        </div>
                        <button
                          @click.stop="removeFile(index)"
                          class="opacity-0 group-hover:opacity-100 p-1 hover:bg-red-600/20 rounded transition"
                        >
                          <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M6 18L18 6M6 6l12 12"></path>
                          </svg>
                        </button>
                      </div>
                    </template>
                  </div>
                </template>
              </div>
            </div>

            <div class="mt-4 space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm text-gray-300 mb-2">Window Style</label>
                  <select
                    x-model="windowStyle"
                    class="w-full bg-gray-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
                  >
                    <option value="macos-sequoia">macOS Sequoia</option>
                    <option value="macos-ventura">macOS Ventura</option>
                    <option value="windows-11">Windows 11</option>
                    <option value="windows-10">Windows 10</option>
                    <option value="chromeos">Chrome OS</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm text-gray-300 mb-2">Theme</label>
                  <select
                    x-model="theme"
                    class="w-full bg-gray-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
                  >
                    <option value="dracula">Dracula</option>
                    <option value="monokai">Monokai</option>
                    <option value="github">GitHub</option>
                    <option value="nord">Nord</option>
                  </select>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm text-gray-300 mb-2">Font Size: <span x-text="fontSize"></span>px</label>
                  <input
                    type="range"
                    min="10"
                    max="24"
                    x-model="fontSize"
                    class="w-full"
                  />
                </div>
                
                <div>
                  <label class="block text-sm text-gray-300 mb-2">Desktop Padding: <span x-text="padding"></span>px</label>
                  <input
                    type="range"
                    min="32"
                    max="128"
                    x-model="padding"
                    class="w-full"
                  />
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm text-gray-300 mb-2">Filename</label>
                  <input
                    type="text"
                    x-model="filename"
                    class="w-full bg-gray-700 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                    placeholder="README.md"
                  />
                </div>
                
                <div>
                  <label class="block text-sm text-gray-300 mb-2">Watermark</label>
                  <input
                    type="text"
                    x-model="watermark"
                    class="w-full bg-gray-700 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                    placeholder="@username"
                  />
                </div>
              </div>

              <div x-show="watermark" class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm text-gray-300 mb-2">Watermark Size: <span x-text="watermarkSize"></span>px</label>
                  <input
                    type="range"
                    min="8"
                    max="24"
                    x-model="watermarkSize"
                    class="w-full"
                  />
                </div>
                
                <div>
                  <label class="block text-sm text-gray-300 mb-2">Watermark Opacity: <span x-text="watermarkOpacity"></span>%</label>
                  <input
                    type="range"
                    min="10"
                    max="100"
                    x-model="watermarkOpacity"
                    class="w-full"
                  />
                </div>
              </div>

              <div>
                <label class="flex items-center gap-2 text-gray-300 cursor-pointer">
                  <input
                    type="checkbox"
                    x-model="useFiraCode"
                    class="w-4 h-4"
                  />
                  Use Fira Code font (ligatures)
                </label>
              </div>

              <div>
                <label class="flex items-center gap-2 text-gray-300 cursor-pointer">
                  <input
                    type="checkbox"
                    x-model="useMermaid"
                    class="w-4 h-4"
                  />
                  Enable Mermaid diagrams
                </label>
              </div>

              <div>
                <label class="flex items-center gap-2 text-gray-300 cursor-pointer">
                  <input
                    type="checkbox"
                    x-model="useKatex"
                    class="w-4 h-4"
                  />
                  Enable KaTeX math formulas
                </label>
              </div>
            </div>
          </div>

          <!-- Preview -->
          <div class="bg-gray-800 rounded-lg shadow-2xl p-6" :class="{ 'fullscreen-mode': isFullscreen }">
            <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
              <h2 class="text-xl font-semibold text-white">Preview</h2>
              <div class="flex gap-2 toolbar-buttons">
                <button
                  @click="copyImage"
                  class="px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition flex items-center gap-2 text-sm"
                  title="Copy as image (Chrome/Edge only)"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                  </svg>
                  <span>Copy Image</span>
                </button>
                <button
                  @click="exportImage"
                  class="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition flex items-center gap-2 text-sm"
                  aria-label="Export as PNG image"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  <span>PNG</span>
                </button>
                <!-- Export SVG -->
                <button
                  @click="exportSVG"
                  class="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition flex items-center gap-2 text-sm"
                  title="Export as SVG"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <path d="M14 2v6h6"></path>
                  </svg>
                  <span>SVG</span>
                </button>
                <!-- Copy HTML -->
                <button
                  @click="copyHTML"
                  class="px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition flex items-center gap-2 text-sm"
                  title="Copy as HTML"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M16 18l6-6-6-6M8 6l-6 6 6 6"></path>
                  </svg>
                  <span>HTML</span>
                </button>
                <!-- Share URL -->
                <button
                  @click="shareURL"
                  class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition flex items-center gap-2 text-sm"
                  title="Copy shareable URL"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <circle cx="18" cy="5" r="3"></circle>
                    <circle cx="6" cy="12" r="3"></circle>
                    <circle cx="18" cy="19" r="3"></circle>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                  </svg>
                  <span>Share</span>
                </button>
                <!-- Fullscreen -->
                <button
                  @click="toggleFullscreen"
                  class="px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition flex items-center gap-2 text-sm"
                  :aria-label="isFullscreen ? 'Exit fullscreen' : 'Enter fullscreen'"
                  :title="'Fullscreen (F11)'"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <template x-if="!isFullscreen"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></template>
                    <template x-if="isFullscreen"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path></template>
                  </svg>
                </button>
                <!-- Print -->
                <button
                  @click="window.print()"
                  class="px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition flex items-center gap-2 text-sm"
                  aria-label="Print preview"
                  title="Print"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                    <rect x="6" y="14" width="12" height="8"></rect>
                  </svg>
                </button>
              </div>
              <!-- Undo/Redo row -->
              <div class="flex items-center gap-2 no-print">
                <button
                  @click="undo"
                  :disabled="historyIndex <= 0"
                  class="px-2 py-1 bg-gray-700 hover:bg-gray-600 disabled:opacity-40 text-white rounded text-xs flex items-center gap-1"
                  title="Undo (Ctrl+Z)"
                >
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 10h10a5 5 0 0 1 5 5v2M3 10l4-4M3 10l4 4"></path></svg>
                  Undo
                </button>
                <button
                  @click="redo"
                  :disabled="historyIndex >= history.length - 1"
                  class="px-2 py-1 bg-gray-700 hover:bg-gray-600 disabled:opacity-40 text-white rounded text-xs flex items-center gap-1"
                  title="Redo (Ctrl+Y)"
                >
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 10H11a5 5 0 0 0-5 5v2M21 10l-4-4M21 10l-4 4"></path></svg>
                  Redo
                </button>
                <span class="text-gray-500 text-xs ml-2" x-show="history.length > 1">
                  <span x-text="historyIndex + 1"></span>/<span x-text="history.length"></span>
                </span>
                <button
                  @click="if(confirm('Clear saved content?')) clearSaved()"
                  class="px-2 py-1 bg-red-700/50 hover:bg-red-600 text-white rounded text-xs ml-auto"
                  title="Clear saved data"
                >
                  Clear
                </button>
              </div>
            </div>

            <!-- OS Background Wrapper -->
            <div 
              class="rounded-lg"
              :style="`${osBackground} padding: ${padding}px;`"
            >
              <!-- Window Container -->
              <div 
                class="shadow-2xl overflow-hidden"
                :class="windowBorderRadius"
                :style="windowBorder"
              >
                <!-- macOS: Separate frame with title bar -->
                <template x-if="windowStyle.includes('macos')">
                  <div :style="windowFrameStyle">
                    <div :style="titleBarStyle">
                      <div class="flex items-center py-3 px-4">
                        <div class="flex items-center gap-2">
                          <div class="w-3 h-3 rounded-full bg-[#ff5f57] hover:bg-[#ff5f57]/90 cursor-pointer transition-all shadow-sm group relative">
                            <svg class="w-2 h-2 absolute inset-0 m-auto opacity-0 group-hover:opacity-100 transition" fill="none" stroke="#4d0000" stroke-width="2" viewBox="0 0 8 8">
                              <path d="M1.5 1.5l5 5m0-5l-5 5"/>
                            </svg>
                          </div>
                          <div class="w-3 h-3 rounded-full bg-[#febc2e] hover:bg-[#febc2e]/90 cursor-pointer transition-all shadow-sm group relative">
                            <svg class="w-2 h-2 absolute inset-0 m-auto opacity-0 group-hover:opacity-100 transition" fill="#995700" viewBox="0 0 8 8">
                              <rect x="1" y="3.5" width="6" height="1"/>
                            </svg>
                          </div>
                          <div class="w-3 h-3 rounded-full bg-[#28c840] hover:bg-[#28c840]/90 cursor-pointer transition-all shadow-sm group relative">
                            <svg class="w-2 h-2 absolute inset-0 m-auto opacity-0 group-hover:opacity-100 transition" fill="none" stroke="#004d0d" stroke-width="1.5" viewBox="0 0 8 8">
                              <path d="M1 3l1.5 1.5L6 1"/>
                            </svg>
                          </div>
                        </div>
                        <div class="flex-1 text-center">
                          <div class="text-xs font-medium text-gray-700">
                            <span x-text="filename || 'README.md'"></span>
                          </div>
                        </div>
                        <div class="w-[52px]"></div>
                      </div>
                    </div>
                    
                    <!-- Content Area -->
                    <div 
                      x-ref="preview"
                      class="content-scroll relative preview-content"
                      :class="theme === 'github' ? 'theme-github' : ''"
                      :style="`background-color: ${currentTheme.bg}; color: ${currentTheme.fg}; font-size: ${fontSize}px; padding: 24px 32px; max-height: 500px; overflow-y: auto;`"
                    >
                      <div class="markdown-content" x-html="parsedMarkdown"></div>
                      
                      <!-- Watermark -->
                      <div 
                        x-show="watermark"
                        class="absolute bottom-4 right-4 font-mono"
                        :style="`color: ${currentTheme.fg}; opacity: ${watermarkOpacity / 100}; font-size: ${watermarkSize}px;`"
                        x-text="watermark"
                      ></div>
                    </div>
                  </div>
                </template>

                <!-- Windows/ChromeOS: No frame, title bar directly on content -->
                <template x-if="!windowStyle.includes('macos')">
                  <div>
                    <!-- Title Bar -->
                    <div :style="titleBarStyle">
                      <!-- Windows 11 -->
                      <template x-if="windowStyle === 'windows-11'">
                        <div class="flex items-center justify-between" style="padding: 0 16px 0 16px; height: 40px;">
                          <div class="flex items-center gap-3">
                            <svg class="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 16 16">
                              <path d="M1.75 1.75v5.5h5.5v-5.5h-5.5zm7 0v5.5h5.5v-5.5h-5.5zm-7 7v5.5h5.5v-5.5h-5.5zm7 0v5.5h5.5v-5.5h-5.5z"/>
                            </svg>
                            <div class="text-xs font-normal text-gray-700">
                              <span x-text="filename || 'README.md'"></span>
                            </div>
                          </div>
                          <div class="flex items-center h-full" style="margin-right: -16px;">
                            <button class="w-12 h-full flex items-center justify-center hover:bg-black/5 transition-colors">
                              <svg class="w-2.5 h-2.5 text-gray-700" fill="currentColor" viewBox="0 0 12 12">
                                <rect x="1" y="5.5" width="10" height="1"/>
                              </svg>
                            </button>
                            <button class="w-12 h-full flex items-center justify-center hover:bg-black/5 transition-colors">
                              <svg class="w-2.5 h-2.5 text-gray-700" fill="none" stroke="currentColor" stroke-width="1" viewBox="0 0 12 12">
                                <rect x="2.5" y="2.5" width="7" height="7"/>
                              </svg>
                            </button>
                            <button class="w-12 h-full flex items-center justify-center hover:bg-[#c42b1c] hover:text-white transition-colors">
                              <svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" stroke-width="1.2" viewBox="0 0 12 12">
                                <path d="M2.5 2.5l7 7m0-7l-7 7"/>
                              </svg>
                            </button>
                          </div>
                        </div>
                      </template>

                      <!-- Windows 10 -->
                      <template x-if="windowStyle === 'windows-10'">
                        <div class="flex items-center justify-between" style="padding: 0 8px 0 8px; height: 32px;">
                          <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 16 16">
                              <path d="M14 2H2v12h12V2zM4 4h8v2H4V4zm0 3h8v2H4V7zm0 3h5v2H4v-2z"/>
                            </svg>
                            <div class="text-xs text-gray-700">
                              <span x-text="filename || 'README.md'"></span>
                            </div>
                          </div>
                          <div class="flex items-center h-full" style="margin-right: -8px;">
                            <button class="w-11 h-full flex items-center justify-center hover:bg-black/5 transition-colors">
                              <svg class="w-2.5 h-2.5 text-gray-700" fill="currentColor" viewBox="0 0 12 12">
                                <rect x="1" y="5.5" width="10" height="1"/>
                              </svg>
                            </button>
                            <button class="w-11 h-full flex items-center justify-center hover:bg-black/5 transition-colors">
                              <svg class="w-2.5 h-2.5 text-gray-700" fill="none" stroke="currentColor" stroke-width="1" viewBox="0 0 12 12">
                                <rect x="2.5" y="2.5" width="7" height="7"/>
                              </svg>
                            </button>
                            <button class="w-11 h-full flex items-center justify-center hover:bg-[#e81123] hover:text-white transition-colors">
                              <svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" stroke-width="1.2" viewBox="0 0 12 12">
                                <path d="M2.5 2.5l7 7m0-7l-7 7"/>
                              </svg>
                            </button>
                          </div>
                        </div>
                      </template>

                      <!-- Chrome OS -->
                      <template x-if="windowStyle === 'chromeos'">
                        <div class="flex items-center justify-between py-2 px-4">
                          <div class="flex items-center gap-3">
                            <svg class="w-4 h-4 text-gray-700" fill="currentColor" viewBox="0 0 16 16">
                              <circle cx="8" cy="8" r="6" fill="none" stroke="currentColor" stroke-width="1.5"/>
                              <circle cx="8" cy="8" r="2.5"/>
                            </svg>
                            <div class="text-xs font-medium text-gray-700">
                              <span x-text="filename || 'README.md'"></span>
                            </div>
                          </div>
                          <div class="flex items-center gap-1">
                            <button class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-black/10 transition">
                              <svg class="w-4 h-4 text-gray-700" fill="currentColor" viewBox="0 0 16 16">
                                <rect x="3" y="7.5" width="10" height="1"/>
                              </svg>
                            </button>
                            <button class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-black/10 transition">
                              <svg class="w-4 h-4 text-gray-700" fill="currentColor" viewBox="0 0 16 16">
                                <rect x="4" y="4" width="8" height="8" fill="none" stroke="currentColor" stroke-width="1.5"/>
                              </svg>
                            </button>
                            <button class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-black/10 transition">
                              <svg class="w-4 h-4 text-gray-700" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M4 4l8 8m0-8l-8 8" stroke="currentColor" stroke-width="1.5" fill="none"/>
                              </svg>
                            </button>
                          </div>
                        </div>
                      </template>
                    </div>

                    <!-- Content Area -->
                    <div 
                      x-ref="preview"
                      class="content-scroll relative preview-content"
                      :class="theme === 'github' ? 'theme-github' : ''"
                      :style="`background-color: ${currentTheme.bg}; color: ${currentTheme.fg}; font-size: ${fontSize}px; padding: 24px 32px; max-height: 500px; overflow-y: auto;`"
                    >
                      <div class="markdown-content" x-html="parsedMarkdown"></div>
                      
                      <!-- Watermark -->
                      <div 
                        x-show="watermark"
                        class="absolute bottom-4 right-4 font-mono"
                        :style="`color: ${currentTheme.fg}; opacity: ${watermarkOpacity / 100}; font-size: ${watermarkSize}px;`"
                        x-text="watermark"
                      ></div>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Lazy Loading Utilities
    const loadedScripts = new Set();
    const loadedStyles = new Set();
    
    function loadScript(src) {
      if (loadedScripts.has(src)) return Promise.resolve();
      
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = () => {
          loadedScripts.add(src);
          resolve();
        };
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }
    
    function loadStyle(href) {
      if (loadedStyles.has(href)) return Promise.resolve();
      
      return new Promise((resolve, reject) => {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = href;
        link.onload = () => {
          loadedStyles.add(href);
          resolve();
        };
        link.onerror = reject;
        document.head.appendChild(link);
      });
    }
    
    // Lazy load KaTeX
    async function loadKaTeX() {
      if (window.katex) return;
      
      await Promise.all([
        loadStyle('https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css'),
        loadScript('https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js')
      ]);
      
      await loadScript('https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js');
    }
    
    // Lazy load Mermaid
    async function loadMermaid() {
      if (window.mermaid) return;
      
      await loadScript('https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js');
      
      if (window.mermaid) {
        mermaid.initialize({ startOnLoad: false, theme: 'dark' });
      }
    }
    
    function app() {
      return {
        content: '',
        editorMode: 'markdown',
        files: [],
        selectedFileIndex: null,
        loadingFolder: false,
        mode: 'markdown',
        language: 'javascript',
        theme: 'dracula',
        windowStyle: 'macos-sequoia',
        fontSize: 14,
        padding: 32,
        showLineNumbers: true,
        filename: 'README.md',
        watermark: '@sandikodev',
        watermarkSize: 24,
        watermarkOpacity: 30,
        useFiraCode: true,
        useMermaid: true,
        useKatex: true,
        
        // UX Polish features
        isFullscreen: false,
        history: [],
        historyIndex: -1,
        maxHistory: 50,
        autoSaveTimer: null,
        
        // Loading & Toast
        isExporting: false,
        toast: { show: false, message: '', type: 'success' },

        themes: {
          dracula: {
            bg: '#282a36',
            fg: '#f8f8f2',
            comment: '#6272a4',
            accent: '#bd93f9',
            blockquoteBg: 'rgba(98, 114, 164, 0.1)',
            blockquoteBorder: '#6272a4',
            tableBorder: '#44475a',
            tableHeaderBg: '#44475a',
            codeBlockBg: '#1e1f29'
          },
          monokai: {
            bg: '#272822',
            fg: '#f8f8f2',
            comment: '#75715e',
            accent: '#ae81ff',
            blockquoteBg: 'rgba(117, 113, 94, 0.1)',
            blockquoteBorder: '#75715e',
            tableBorder: '#3e3d32',
            tableHeaderBg: '#3e3d32',
            codeBlockBg: '#1e1e1e'
          },
          github: {
            bg: '#ffffff',
            fg: '#24292e',
            comment: '#6a737d',
            accent: '#6f42c1',
            blockquoteBg: 'rgba(106, 115, 125, 0.05)',
            blockquoteBorder: '#dfe2e5',
            tableBorder: '#dfe2e5',
            tableHeaderBg: '#f6f8fa',
            codeBlockBg: '#f6f8fa'
          },
          nord: {
            bg: '#2e3440',
            fg: '#d8dee9',
            comment: '#616e88',
            accent: '#88c0d0',
            blockquoteBg: 'rgba(97, 110, 136, 0.1)',
            blockquoteBorder: '#616e88',
            tableBorder: '#3b4252',
            tableHeaderBg: '#3b4252',
            codeBlockBg: '#3b4252'
          }
        },

        get currentTheme() {
          return this.themes[this.theme];
        },

        get osBackground() {
          const styles = {
            'macos-sequoia': 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);',
            'macos-ventura': 'background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);',
            'windows-11': 'background: linear-gradient(135deg, #0078d4 0%, #00bcf2 100%);',
            'windows-10': 'background: linear-gradient(135deg, #0078d7 0%, #00a4ef 100%);',
            'chromeos': 'background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);'
          };
          return styles[this.windowStyle];
        },

        get windowBorderRadius() {
          const radius = {
            'macos-sequoia': 'rounded-xl',
            'macos-ventura': 'rounded-xl',
            'windows-11': 'rounded-lg',
            'windows-10': 'rounded-none',
            'chromeos': 'rounded-lg'
          };
          return radius[this.windowStyle];
        },

        get windowBorder() {
          const borders = {
            'macos-sequoia': 'border: 1px solid rgba(0,0,0,0.1);',
            'macos-ventura': 'border: 1px solid rgba(0,0,0,0.1);',
            'windows-11': 'border: 1px solid #e5e5e5; box-shadow: 0 8px 32px rgba(0,0,0,0.12);',
            'windows-10': 'border: 1px solid #0078d7; box-shadow: 0 0 0 1px rgba(0,0,0,0.05);',
            'chromeos': 'border: 1px solid #dadce0; box-shadow: 0 1px 3px rgba(60,64,67,0.3);'
          };
          return borders[this.windowStyle];
        },

        get windowFrameStyle() {
          // Only macOS has separate frame
          if (this.windowStyle.includes('macos')) {
            return 'background: rgba(236, 236, 236, 0.95); backdrop-filter: blur(40px);';
          }
          return '';
        },

        get titleBarStyle() {
          const styles = {
            'macos-sequoia': 'background: transparent;',
            'macos-ventura': 'background: transparent;',
            'windows-11': 'background: #f3f3f3;',
            'windows-10': 'background: #ffffff; border-bottom: 1px solid #e5e5e5;',
            'chromeos': 'background: #ffffff; border-bottom: 1px solid #e8eaed;'
          };
          return styles[this.windowStyle];
        },

        get parsedMarkdown() {
          const raw = marked.parse(this.content);
          let html = DOMPurify.sanitize(raw);
          
          // Lazy load and process Mermaid diagrams if enabled
          if (this.useMermaid && html.includes('language-mermaid')) {
            loadMermaid().then(() => {
              this.$nextTick(() => {
                if (window.mermaid) {
                  mermaid.run();
                }
              });
            });
            
            html = html.replace(/<pre><code class="language-mermaid">([\s\S]*?)<\/code><\/pre>/g, (match, code) => {
              const decoded = code
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&amp;/g, '&')
                .replace(/&quot;/g, '"')
                .replace(/&#39;/g, "'");
              return `<div class="mermaid">${decoded}</div>`;
            });
          }
          
          // Lazy load KaTeX if math detected
          if (this.useKatex && (html.includes('$') || html.includes('\\('))) {
            loadKaTeX().then(() => {
              this.$nextTick(() => {
                if (window.renderMathInElement) {
                  const element = document.querySelector('.preview-content');
                  if (element) {
                    renderMathInElement(element, {
                      delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                      ]
                    });
                  }
                }
              });
            });
          }
          
          return html;
        },

        get highlightedCode() {
          const escaped = this.content
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
          
          if (this.showLineNumbers) {
            const lines = escaped.split('\n');
            return lines.map((line, i) => 
              `<span style="color: ${this.currentTheme.comment}; user-select: none; display: inline-block; min-width: 3ch; text-align: right; margin-right: 1em;">${i + 1}</span>${line}`
            ).join('\n');
          }
          return escaped;
        },

        get styles() {
          const t = this.currentTheme;
          const scrollbarStyles = this.scrollbarStyles;
          const fontFamily = this.useFiraCode ? "'Fira Code', monospace" : "Consolas, Monaco, 'Andale Mono', monospace";
          
          return `
            .markdown-content {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
              line-height: 1.7;
            }
            .markdown-content h1, .markdown-content h2 {
              border-bottom: 1px solid ${t.tableBorder};
              padding-bottom: 0.3em;
              margin: 1em 0 0.5em 0;
            }
            .markdown-content h1 { font-size: 2em; font-weight: 600; }
            .markdown-content h2 { font-size: 1.5em; font-weight: 600; }
            .markdown-content h3 { font-size: 1.25em; font-weight: 600; margin: 1em 0 0.5em 0; }
            .markdown-content blockquote {
              border-left: 4px solid ${t.blockquoteBorder};
              background: ${t.blockquoteBg};
              padding: 0.8em 1em;
              margin: 1em 0;
              border-radius: 4px;
              color: ${t.comment};
            }
            .markdown-content code {
              background: ${t.codeBlockBg};
              padding: 0.2em 0.4em;
              border-radius: 3px;
              font-family: ${fontFamily};
              font-size: 0.9em;
              ${this.useFiraCode ? 'font-feature-settings: "liga" 1, "calt" 1;' : ''}
            }
            .markdown-content pre {
              background: ${t.codeBlockBg};
              padding: 1em;
              border-radius: 6px;
              overflow-x: auto;
              margin: 1em 0;
            }
            .markdown-content pre code {
              background: none;
              padding: 0;
              font-family: ${fontFamily};
              ${this.useFiraCode ? 'font-feature-settings: "liga" 1, "calt" 1;' : ''}
            }
            .markdown-content table {
              border-collapse: collapse;
              width: 100%;
              margin: 1.5em 0;
              border: 1px solid ${t.tableBorder};
              border-radius: 6px;
              overflow: hidden;
            }
            .markdown-content th {
              background: ${t.tableHeaderBg};
              padding: 0.75em 1em;
              font-weight: 600;
              text-align: left;
              border-bottom: 2px solid ${t.tableBorder};
            }
            .markdown-content td {
              padding: 0.75em 1em;
              border-bottom: 1px solid ${t.tableBorder};
            }
            .markdown-content tr:last-child td {
              border-bottom: none;
            }
            .markdown-content tr:hover {
              background: ${t.blockquoteBg};
            }
            .markdown-content strong { 
              font-weight: 600; 
              color: ${t.accent}; 
            }
            .markdown-content ul, .markdown-content ol {
              margin: 1em 0;
              padding-left: 2em;
            }
            .markdown-content li {
              margin: 0.5em 0;
            }
            
            /* Custom Scrollbar Styles */
            ${scrollbarStyles}
          `;
        },

        get scrollbarStyles() {
          const t = this.currentTheme;
          const isDark = t.bg !== '#ffffff';
          
          // macOS style - overlay scrollbar
          if (this.windowStyle.includes('macos')) {
            return `
              .content-scroll::-webkit-scrollbar,
              .markdown-content pre::-webkit-scrollbar,
              pre[class*="language-"]::-webkit-scrollbar {
                width: 10px;
                height: 10px;
              }
              .content-scroll::-webkit-scrollbar-track,
              .markdown-content pre::-webkit-scrollbar-track,
              pre[class*="language-"]::-webkit-scrollbar-track {
                background: transparent;
              }
              .content-scroll::-webkit-scrollbar-thumb,
              .markdown-content pre::-webkit-scrollbar-thumb,
              pre[class*="language-"]::-webkit-scrollbar-thumb {
                background: ${isDark ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.2)'};
                border-radius: 10px;
                border: 2px solid ${t.bg};
              }
              .content-scroll::-webkit-scrollbar-thumb:hover,
              .markdown-content pre::-webkit-scrollbar-thumb:hover,
              pre[class*="language-"]::-webkit-scrollbar-thumb:hover {
                background: ${isDark ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.3)'};
              }
              .content-scroll::-webkit-scrollbar-corner,
              .markdown-content pre::-webkit-scrollbar-corner,
              pre[class*="language-"]::-webkit-scrollbar-corner {
                background: transparent;
              }
            `;
          }
          
          // Windows 11 style - modern thin scrollbar
          if (this.windowStyle === 'windows-11') {
            return `
              .content-scroll::-webkit-scrollbar,
              .markdown-content pre::-webkit-scrollbar,
              pre[class*="language-"]::-webkit-scrollbar {
                width: 12px;
                height: 12px;
              }
              .content-scroll::-webkit-scrollbar-track,
              .markdown-content pre::-webkit-scrollbar-track,
              pre[class*="language-"]::-webkit-scrollbar-track {
                background: ${isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)'};
              }
              .content-scroll::-webkit-scrollbar-thumb,
              .markdown-content pre::-webkit-scrollbar-thumb,
              pre[class*="language-"]::-webkit-scrollbar-thumb {
                background: ${isDark ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.3)'};
                border-radius: 6px;
              }
              .content-scroll::-webkit-scrollbar-thumb:hover,
              .markdown-content pre::-webkit-scrollbar-thumb:hover,
              pre[class*="language-"]::-webkit-scrollbar-thumb:hover {
                background: ${isDark ? 'rgba(255,255,255,0.4)' : 'rgba(0,0,0,0.4)'};
              }
              .content-scroll::-webkit-scrollbar-corner,
              .markdown-content pre::-webkit-scrollbar-corner,
              pre[class*="language-"]::-webkit-scrollbar-corner {
                background: ${isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)'};
              }
            `;
          }
          
          // Windows 10 style - classic scrollbar
          if (this.windowStyle === 'windows-10') {
            return `
              .content-scroll::-webkit-scrollbar,
              .markdown-content pre::-webkit-scrollbar,
              pre[class*="language-"]::-webkit-scrollbar {
                width: 17px;
                height: 17px;
              }
              .content-scroll::-webkit-scrollbar-track,
              .markdown-content pre::-webkit-scrollbar-track,
              pre[class*="language-"]::-webkit-scrollbar-track {
                background: ${isDark ? '#1a1a1a' : '#f0f0f0'};
              }
              .content-scroll::-webkit-scrollbar-thumb,
              .markdown-content pre::-webkit-scrollbar-thumb,
              pre[class*="language-"]::-webkit-scrollbar-thumb {
                background: ${isDark ? '#555555' : '#c1c1c1'};
                border: 1px solid ${isDark ? '#3a3a3a' : '#a0a0a0'};
              }
              .content-scroll::-webkit-scrollbar-thumb:hover,
              .markdown-content pre::-webkit-scrollbar-thumb:hover,
              pre[class*="language-"]::-webkit-scrollbar-thumb:hover {
                background: ${isDark ? '#666666' : '#a8a8a8'};
              }
              .content-scroll::-webkit-scrollbar-button,
              .markdown-content pre::-webkit-scrollbar-button,
              pre[class*="language-"]::-webkit-scrollbar-button {
                width: 17px;
                height: 17px;
                background: ${isDark ? '#2a2a2a' : '#e0e0e0'};
                border: 1px solid ${isDark ? '#3a3a3a' : '#a0a0a0'};
              }
              .content-scroll::-webkit-scrollbar-corner,
              .markdown-content pre::-webkit-scrollbar-corner,
              pre[class*="language-"]::-webkit-scrollbar-corner {
                background: ${isDark ? '#1a1a1a' : '#f0f0f0'};
              }
            `;
          }
          
          // Chrome OS style - Material Design scrollbar
          if (this.windowStyle === 'chromeos') {
            return `
              .content-scroll::-webkit-scrollbar,
              .markdown-content pre::-webkit-scrollbar,
              pre[class*="language-"]::-webkit-scrollbar {
                width: 8px;
                height: 8px;
              }
              .content-scroll::-webkit-scrollbar-track,
              .markdown-content pre::-webkit-scrollbar-track,
              pre[class*="language-"]::-webkit-scrollbar-track {
                background: transparent;
              }
              .content-scroll::-webkit-scrollbar-thumb,
              .markdown-content pre::-webkit-scrollbar-thumb,
              pre[class*="language-"]::-webkit-scrollbar-thumb {
                background: ${isDark ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.3)'};
                border-radius: 4px;
              }
              .content-scroll::-webkit-scrollbar-thumb:hover,
              .markdown-content pre::-webkit-scrollbar-thumb:hover,
              pre[class*="language-"]::-webkit-scrollbar-thumb:hover {
                background: ${isDark ? 'rgba(255,255,255,0.4)' : 'rgba(0,0,0,0.4)'};
              }
              .content-scroll::-webkit-scrollbar-corner,
              .markdown-content pre::-webkit-scrollbar-corner,
              pre[class*="language-"]::-webkit-scrollbar-corner {
                background: transparent;
              }
            `;
          }
          
          return '';
        },

        init() {
          // Load from URL, localStorage, or default
          if (!this.loadFromURL()) {
            const saved = localStorage.getItem('snapcode-content');
            if (saved) {
              this.content = saved;
              this.pushHistory(saved);
            } else {
              this.loadDefault();
            }
          }
          
          // Load saved settings
          const settings = localStorage.getItem('snapcode-settings');
          if (settings) {
            const s = JSON.parse(settings);
            Object.assign(this, { theme: s.theme, windowStyle: s.windowStyle, fontSize: s.fontSize, useFiraCode: s.useFiraCode });
          }
          
          // Keyboard shortcuts
          document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
              e.preventDefault();
              this.exportImage();
            }
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'c') {
              e.preventDefault();
              this.copyImage();
            }
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 't') {
              e.preventDefault();
              this.copyText();
            }
            // Undo: Ctrl+Z
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
              e.preventDefault();
              this.undo();
            }
            // Redo: Ctrl+Shift+Z or Ctrl+Y
            if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.shiftKey && e.key === 'z'))) {
              e.preventDefault();
              this.redo();
            }
            // Fullscreen: F11 or Ctrl+Shift+F
            if (e.key === 'F11' || ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'f')) {
              e.preventDefault();
              this.toggleFullscreen();
            }
            // Escape to exit fullscreen
            if (e.key === 'Escape' && this.isFullscreen) {
              this.isFullscreen = false;
            }
          });
          
          // Watch content for autosave and history
          this.$watch('content', (val, oldVal) => {
            // Autosave with debounce
            clearTimeout(this.autoSaveTimer);
            this.autoSaveTimer = setTimeout(() => {
              localStorage.setItem('snapcode-content', val);
            }, 500);
            
            // Push to history (debounced)
            if (oldVal !== undefined && val !== this.history[this.historyIndex]) {
              this.pushHistory(val);
            }
            
            if (this.useMermaid && window.mermaid) {
              this.$nextTick(() => mermaid.run({ querySelector: '.mermaid' }));
            }
            if (this.useKatex && window.renderMathInElement) {
              this.$nextTick(() => this.renderKatex());
            }
          });
          
          // Save settings on change
          ['theme', 'windowStyle', 'fontSize', 'useFiraCode'].forEach(key => {
            this.$watch(key, () => this.saveSettings());
          });
          
          this.$watch('useMermaid', async () => {
            if (this.useMermaid) {
              await loadMermaid();
              this.$nextTick(() => mermaid.run({ querySelector: '.mermaid' }));
            }
          });
          
          this.$watch('useKatex', async () => {
            if (this.useKatex) {
              await loadKatex();
              this.$nextTick(() => this.renderKatex());
            }
          });
        },
        
        // Autosave settings
        saveSettings() {
          localStorage.setItem('snapcode-settings', JSON.stringify({
            theme: this.theme, windowStyle: this.windowStyle, fontSize: this.fontSize, useFiraCode: this.useFiraCode
          }));
        },
        
        // Undo/Redo
        pushHistory(content) {
          if (this.historyIndex < this.history.length - 1) {
            this.history = this.history.slice(0, this.historyIndex + 1);
          }
          this.history.push(content);
          if (this.history.length > this.maxHistory) this.history.shift();
          this.historyIndex = this.history.length - 1;
        },
        
        undo() {
          if (this.historyIndex > 0) {
            this.historyIndex--;
            this.content = this.history[this.historyIndex];
          }
        },
        
        redo() {
          if (this.historyIndex < this.history.length - 1) {
            this.historyIndex++;
            this.content = this.history[this.historyIndex];
          }
        },
        
        // Fullscreen
        toggleFullscreen() {
          this.isFullscreen = !this.isFullscreen;
        },
        
        // Clear saved data
        clearSaved() {
          localStorage.removeItem('snapcode-content');
          localStorage.removeItem('snapcode-settings');
          this.loadDefault();
          this.showToast('Saved data cleared', 'success');
        },
        
        // Toast notification
        showToast(message, type = 'success') {
          this.toast = { show: true, message, type };
          setTimeout(() => this.toast.show = false, 3000);
        },
        
        // Share via URL
        shareURL() {
          const encoded = btoa(encodeURIComponent(this.content));
          const url = `${location.origin}${location.pathname}?c=${encoded}`;
          navigator.clipboard.writeText(url).then(() => {
            this.showToast('Share URL copied!', 'success');
          });
        },
        
        // Load from URL if present
        loadFromURL() {
          const params = new URLSearchParams(location.search);
          const encoded = params.get('c');
          if (encoded) {
            try {
              this.content = decodeURIComponent(atob(encoded));
              this.pushHistory(this.content);
              return true;
            } catch(e) {}
          }
          return false;
        },
        
        // Copy as HTML
        copyHTML() {
          const html = this.$refs.preview.innerHTML;
          navigator.clipboard.writeText(html).then(() => {
            this.showToast('HTML copied!', 'success');
          });
        },
        
        // Export SVG
        async exportSVG() {
          this.isExporting = true;
          try {
            const preview = this.$refs.preview;
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="800" height="${preview.scrollHeight}">
              <foreignObject width="100%" height="100%">
                <div xmlns="http://www.w3.org/1999/xhtml" style="background:${this.currentTheme.bg};color:${this.currentTheme.fg};padding:24px;font-family:monospace;">
                  ${preview.innerHTML}
                </div>
              </foreignObject>
            </svg>`;
            const blob = new Blob([svg], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${this.filename.replace(/\.[^.]+$/, '')}.svg`;
            a.click();
            URL.revokeObjectURL(url);
            this.showToast('SVG exported!', 'success');
          } catch(e) {
            this.showToast('Export failed', 'error');
          }
          this.isExporting = false;
        },

        renderKatex() {
          const element = this.$refs.preview;
          if (!element || !window.renderMathInElement) return;
          
          renderMathInElement(element, {
            delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\[', right: '\\]', display: true},
              {left: '\\(', right: '\\)', display: false}
            ],
            throwOnError: false
          });
        },

        handleDrop(e) {
          e.target.classList.remove('ring-2', 'ring-purple-400');
          const file = e.dataTransfer.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => this.content = ev.target.result;
            reader.readAsText(file);
          }
        },

        async exportImage() {
          this.isExporting = true;
          try {
            const contentElement = this.$refs.preview;
            const osBackground = contentElement.parentElement.parentElement;
            
            const originalMaxHeight = contentElement.style.maxHeight;
            const originalOverflow = contentElement.style.overflowY;
            
            contentElement.style.maxHeight = 'none';
            contentElement.style.overflowY = 'visible';
            
            await new Promise(resolve => setTimeout(resolve, 300));
            
            const canvas = await html2canvas(osBackground, {
              scale: 2,
              useCORS: true,
              allowTaint: true,
              backgroundColor: null,
            });
            
            contentElement.style.maxHeight = originalMaxHeight;
            contentElement.style.overflowY = originalOverflow;
            
            canvas.toBlob((blob) => {
              const url = URL.createObjectURL(blob);
              const link = document.createElement('a');
              link.download = `${this.filename.replace(/\.[^.]+$/, '')}-${Date.now()}.png`;
              link.href = url;
              link.click();
              URL.revokeObjectURL(url);
              this.showToast('PNG exported!', 'success');
            });
          } catch (err) {
            this.showToast('Export failed: ' + err.message, 'error');
          }
          this.isExporting = false;
        },

        copyText() {
          navigator.clipboard.writeText(this.content)
            .then(() => this.showToast('Text copied!', 'success'))
            .catch(() => this.showToast('Failed to copy', 'error'));
        },

        async loadDefault() {
          try {
            const response = await fetch('content/default.md');
            if (response.ok) {
              this.content = await response.text();
            } else {
              this.content = '# Welcome to SnapCode\n\nStart typing your markdown here...';
            }
          } catch (err) {
            this.content = '# Welcome to SnapCode\n\nStart typing your markdown here...';
          }
        },

        async loadSample() {
          try {
            const response = await fetch('content/sample.md');
            if (response.ok) {
              this.content = await response.text();
            } else {
              alert('sample.md not found');
            }
          } catch (err) {
            console.error('Failed to load sample:', err);
            alert('Failed to load sample.md');
          }
        },

        addFile(event) {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              this.files.push({
                name: file.name,
                content: e.target.result,
                size: file.size
              });
              this.selectFile(this.files.length - 1);
            };
            reader.readAsText(file);
          }
          event.target.value = '';
        },

        async loadFolder(folder) {
          this.loadingFolder = true;
          this.files = [];
          this.selectedFileIndex = null;
          
          try {
            // Try files.json first (for GitHub Pages)
            const jsonResponse = await fetch(`${folder}/files.json`);
            if (jsonResponse.ok) {
              const fileList = await jsonResponse.json();
              
              // Load each file
              for (const fileInfo of fileList) {
                try {
                  const response = await fetch(`${folder}/${fileInfo.name}`);
                  if (response.ok) {
                    const content = await response.text();
                    this.files.push({
                      name: fileInfo.name,
                      content: content,
                      size: content.length
                    });
                  }
                } catch (err) {
                  console.log(`Could not load ${fileInfo.name}`);
                }
              }
            } else {
              // Try dynamic API (for local server)
              const apiResponse = await fetch(`/api/files/${folder}`);
              if (apiResponse.ok) {
                const fileList = await apiResponse.json();
                
                for (const fileInfo of fileList) {
                  try {
                    const response = await fetch(`${folder}/${fileInfo.name}`);
                    if (response.ok) {
                      const content = await response.text();
                      this.files.push({
                        name: fileInfo.name,
                        content: content,
                        size: content.length
                      });
                    }
                  } catch (err) {
                    console.log(`Could not load ${fileInfo.name}`);
                  }
                }
              } else {
                // Fallback to hardcoded list
                const folderFiles = {
                  'content': ['default.md', 'sample.md'],
                  'docs': ['INDEX.md', 'FOLDER_LOADING.md', 'FILE_EXPLORER_FEATURE.md', 'STRUCTURE.md', 'QUICKSTART.md', 'CHANGES_SUMMARY.txt']
                };
                
                const fileList = folderFiles[folder] || [];
                
                for (const filename of fileList) {
                  try {
                    const response = await fetch(`${folder}/${filename}`);
                    if (response.ok) {
                      const content = await response.text();
                      this.files.push({
                        name: filename,
                        content: content,
                        size: content.length
                      });
                    }
                  } catch (err) {
                    console.log(`Could not load ${filename}`);
                  }
                }
              }
            }
          } catch (err) {
            console.error('Error loading folder:', err);
          }
          
          this.loadingFolder = false;
        },

        selectFile(index) {
          this.selectedFileIndex = index;
          this.content = this.files[index].content;
          this.filename = this.files[index].name;
          this.editorMode = 'markdown';
        },

        removeFile(index) {
          this.files.splice(index, 1);
          if (this.selectedFileIndex === index) {
            this.selectedFileIndex = null;
            this.content = '';
          } else if (this.selectedFileIndex > index) {
            this.selectedFileIndex--;
          }
        },

        formatFileSize(bytes) {
          if (bytes < 1024) return bytes + ' B';
          if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
          return (bytes / 1048576).toFixed(1) + ' MB';
        },

        async copyImage() {
          this.isExporting = true;
          try {
            const contentElement = this.$refs.preview;
            const osBackground = contentElement.parentElement.parentElement;
            
            const originalMaxHeight = contentElement.style.maxHeight;
            const originalOverflow = contentElement.style.overflowY;
            
            contentElement.style.maxHeight = 'none';
            contentElement.style.overflowY = 'visible';
            
            await new Promise(resolve => setTimeout(resolve, 200));
            
            const canvas = await html2canvas(osBackground, {
              scale: 2,
              useCORS: true,
              allowTaint: true,
              backgroundColor: null,
            });
            
            contentElement.style.maxHeight = originalMaxHeight;
            contentElement.style.overflowY = originalOverflow;
            
            canvas.toBlob(async (blob) => {
              try {
                await navigator.clipboard.write([
                  new ClipboardItem({ 'image/png': blob })
                ]);
                this.showToast('Image copied!', 'success');
              } catch (err) {
                this.showToast('Copy not supported, use Export', 'error');
              }
            });
          } catch (err) {
            this.showToast('Failed: ' + err.message, 'error');
          }
          this.isExporting = false;
        },
      }
    }
  </script>
  
  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('SW registered:', registration);
          })
          .catch((error) => {
            console.log('SW registration failed:', error);
          });
      });
    }
  </script>
</body>
</html>
